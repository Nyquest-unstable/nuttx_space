# Milestone 2: 音频子系统构建 (Week 3-4)

## 目标
构建完整的音频处理管道，包括录音和播放引擎，为AI语音助手提供音频处理能力。

---

## 2.1 音频管道框架
- [ ] **音频缓冲区管理**
  ```c
  typedef struct {
      uint8_t *buffer;
      size_t size;
      size_t read_ptr;
      size_t write_ptr;
      sem_t sem;
  } audio_pipe_t;
  ```
  
- [ ] **录音管道**
  - 从I2S读取PCM数据
  - 环形缓冲设计 (建议4-8秒缓冲)
  - 支持 overrun 处理

- [ ] **播放管道**
  - 向I2S写入PCM数据
  - 欠载保护 (underrun)
  - 音量调节

## 2.2 录音引擎
- [ ] **连续录音模式**
  - 启动/停止控制
  - 音频数据回调
  - 支持多客户端订阅

- [ ] **音频格式转换**
  - 32bit → 16bit (右移16位)
  - 立体声 → 单声道 (可选)
  - 重采样 (48k→16k如有需要)

## 2.3 播放引擎
- [ ] **音频解码器接口**
  - 支持PCM直接播放
  - 预留Opus解码接口
  
- [ ] **播放队列管理**
  - 支持打断/混音
  - 优先级控制 (提示音 vs TTS)

## 2.4 Opus编解码集成
- [ ] **移植Opus库**
  - 配置`CONFIG_OPUS`
  - 优化内存使用 (减少RAM占用)
  
- [ ] **编码器配置**
  ```c
  // 语音识别优化参数
  - 采样率: 16kHz
  - 帧大小: 20ms (320 samples)
  - 码率: 16-24kbps
  - 复杂度: 3 (低延迟)
  - 应用: OPUS_APPLICATION_VOIP
  ```

- [ ] **解码器配置**
  - 支持流式解码
  - 错误恢复 (FEC)

## 2.5 VAD (语音活动检测)
- [ ] **集成WebRTC VAD**
  - 或轻量级VAD算法
  - 16kHz, 10ms/20ms帧
  
- [ ] **VAD事件触发**
  - 语音开始检测
  - 语音结束检测 (超时)
  - 触发录音上传

## 成功标准
- [ ] 录音引擎能够持续录制高质量音频
- [ ] 播放引擎能够流畅播放音频
- [ ] Opus编解码功能正常，压缩率符合预期
- [ ] VAD能够准确检测语音活动
- [ ] 音频管道无明显延迟和失真